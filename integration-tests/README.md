# Integration Tests for Konflux

This directory contains Tekton integration pipelines for testing go-coverage-http in Konflux CI/CD environment.

## Pipeline: e2e.yaml

The `pipelines/e2e.yaml` pipeline performs end-to-end testing of the instrumented Go application with coverage collection and artifact storage.

### Pipeline Flow

1. **test-metadata** - Extracts metadata about the test run (branch, commit, etc.)
2. **deploy** - Deploys the instrumented container image to OpenShift
3. **run-e2e-tests** - Runs Go E2E tests with coverage collection
4. **cleanup** - Cleans up the test namespace

### Prerequisites

Before running this pipeline, you need to create a secret with the following keys:

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: integration-pipeline-credentials
  namespace: <your-namespace>
type: Opaque
stringData:
  # OpenShift login command
  oc-login-command: "oc login https://api.your-cluster.com --token=sha256~your-token"
  
  # Quay.io authentication for pushing coverage artifacts
  quay-auth-secret: |
    {
      "auths": {
        "quay.io": {
          "auth": "base64-encoded-username:password",
          "email": ""
        }
      }
    }
```

### Setting up Quay.io Authentication

1. Create a robot account in quay.io:
   - Go to https://quay.io/organization/psturc/application
   - Create a robot account (e.g., `psturc+coverage_artifacts_bot`)
   - Grant it write permissions to the `coverage-artifacts` repository

2. Get the base64-encoded credentials:
   ```bash
   echo -n "username:password" | base64
   ```

3. Create the secret in your OpenShift namespace:
   ```bash
   kubectl create secret generic integration-pipeline-credentials \
     --from-literal=oc-login-command="oc login https://..." \
     --from-literal=quay-auth-secret='{"auths":{"quay.io":{"auth":"...","email":""}}}' \
     --from-literal=codecov-token="your-codecov-token-here"
   
   # Note: codecov-token is optional - if not provided, the Codecov upload step will be skipped
   ```

### What the Pipeline Does

#### Deploy Task
- Creates a unique namespace for the test run (e.g., `go-coverage-http-1234567890`)
- Clones the repository
- Updates the deployment manifest with:
  - The snapshot image from Konflux
  - The dynamic namespace
  - Converts NodePort Service to ClusterIP (for OpenShift)
  - Adds an OpenShift Route resource for external access
- Deploys the modified application manifest
- Waits for the deployment and route to be ready
- Exports the route URL (e.g., `https://coverage-demo-namespace.apps.cluster.com`)

**Note:** The base `k8s-deployment.yaml` uses NodePort for local Kind testing. The pipeline automatically converts it to ClusterIP and adds a Route for OpenShift deployments.

#### Run E2E Tests Task
- **Clone Repository Step**: Clones the repository to an emptyDir volume
- **Run Tests Step**: 
  - Uses the cloned code from the emptyDir volume
  - Sets up Docker authentication for quay.io
  - Runs `go test -v ./...` in the `test/` directory
- The tests will:
  - Discover the pod using label selector
  - Port-forward to collect coverage via HTTP
  - Collect binary coverage data and metadata
  - Push coverage artifacts to `quay.io/psturc/coverage-artifacts` as OCI artifacts
- **Outputs**: `COVERAGE_ARTIFACT_REF` - Full OCI reference to the coverage artifact

#### Process Coverage Task
This task processes the coverage data and uploads it to Codecov. It runs after the E2E tests task and receives the artifact reference.

- **Extract Coverage Artifact**: Pulls the OCI artifact using ORAS and extracts `metadata.json`
- **Extract Git Metadata**: Uses cosign to download attestation from the tested image and extracts:
  - Repository URL (from `pipelinesascode.tekton.dev/repo-url` annotation)
  - Commit SHA (from `build.appstudio.redhat.com/commit_sha` annotation)
- **Clone Repository**: Clones the source repository at the exact commit that was tested
- **Process Coverage**: Converts binary coverage data to text format using `go tool covdata textfmt`
- **Upload to Codecov**: Uploads the processed coverage to Codecov (if `codecov-token` is configured)

**Note**: This task will gracefully skip if:
- No coverage artifact was pushed (when `COVERAGE_ARTIFACT_REF = "not-available"`)
- Codecov token is not configured (optional - add `codecov-token` key to `integration-pipeline-credentials` secret)

#### Cleanup Task
- Runs after coverage processing completes
- Deletes the test namespace

### Coverage Artifacts

The E2E tests push coverage data to quay.io as OCI artifacts with the following structure:

**Repository:** `quay.io/psturc/coverage-artifacts`  
**Tag format:** `e2e-coverage-YYYYMMDD-HHMMSS`  
**Expiration:** 1 year (configured via `quay.expires-after` annotation)

Each artifact contains:
- `metadata.json` - Pod and container information (including image reference)
- `covmeta.*` - Binary coverage metadata
- `covcounters.*` - Binary coverage counters
- `coverage.out` - Text coverage report (generated by coverage-processor)
- `coverage_filtered.out` - Filtered coverage report
- `coverage.html` - HTML coverage report

### Usage in Konflux

1. Create the integration test configuration in your Konflux application:
   ```yaml
   apiVersion: appstudio.redhat.com/v1beta1
   kind: IntegrationTestScenario
   metadata:
     name: go-coverage-http-e2e
   spec:
     application: go-coverage-http
     contexts:
       - name: application
         description: Application testing
     resolverRef:
       resolver: git
       params:
         - name: url
           value: https://github.com/psturc/go-coverage-http
         - name: revision
           value: main
         - name: pathInRepo
           value: integration-tests/pipelines/e2e.yaml
   ```

2. The pipeline will automatically run on:
   - New commits to branches
   - Pull requests
   - Manual triggers

### Coverage Processing

After the tests complete and coverage artifacts are pushed to quay.io, you can use the [coverage-processor](https://github.com/psturc/coverage-processor) to:
- Download coverage artifacts from quay.io
- Generate coverage reports
- Upload to SonarQube/SonarCloud
- Create coverage badges

See the coverage-processor documentation for more details.

### Local Testing

#### Testing on Kind/Kubernetes

The base `k8s-deployment.yaml` is configured for local testing with NodePort:

```bash
# Deploy to Kind
kubectl apply -f k8s-deployment.yaml

# Service is accessible via NodePort at http://127.0.0.1:8000
# Run tests manually
cd test
export APP_NAMESPACE=coverage-demo
export APP_URL=http://127.0.0.1:8000
go test -v
```

#### Testing on OpenShift (Manual)

For manual OpenShift testing, you can use the same manifest and access via NodePort, or create a Route manually:

```bash
# Deploy using the base manifest
oc apply -f k8s-deployment.yaml

# Create a Route manually for HTTPS access
oc create route edge coverage-demo --service=coverage-demo -n coverage-demo

# Get the route URL
ROUTE_URL=$(oc get route coverage-demo -n coverage-demo -o jsonpath='{.spec.host}')
echo "App URL: https://${ROUTE_URL}"

# Run tests manually
cd test
export APP_NAMESPACE=coverage-demo
export APP_URL="https://${ROUTE_URL}"
go test -v
```

**Note:** The integration pipeline automatically handles the Service/Route configuration for OpenShift.

### Troubleshooting

**Tests fail to find pod:**
- Check that the namespace is correctly set via `APP_NAMESPACE` environment variable
- Verify the pod has the label `app=coverage-demo`

**Route not accessible:**
- Check route status: `oc get route coverage-demo -n <namespace>`
- Verify route hostname: `oc describe route coverage-demo -n <namespace>`
- Test route manually: `curl -k https://<route-host>/health`
- Check if TLS is properly configured

**Coverage push fails:**
- Ensure you're logged in to quay.io (`docker login quay.io`)
- Check the secret contains valid quay.io credentials
- Verify the robot account has write permissions to the repository
- Check Docker config: `cat ~/.docker/config.json`

**Deployment times out:**
- Check pod logs: `oc logs -l app=coverage-demo -n <namespace>`
- Verify the image exists and is accessible
- Check resource limits in `k8s-deployment.yaml`
- Ensure the image pull secret is correctly configured (if using private registry)

### Pipeline Parameters

- `SNAPSHOT` - JSON snapshot of the application components (automatically provided by Konflux)
  ```json
  {
    "components": [
      {
        "name": "go-coverage-http",
        "containerImage": "quay.io/org/repo:tag"
      }
    ]
  }
  ```

### Environment Variables in Tests

The E2E tests support the following environment variables:

- `APP_NAMESPACE` - Kubernetes namespace (default: `coverage-demo`)
- `APP_URL` - Application base URL (default: `http://127.0.0.1:8000`)
  - **Konflux pipeline**: Set to Route URL `https://coverage-demo-namespace.apps.cluster.com`
  - **Local Kind**: Uses default `http://127.0.0.1:8000` (NodePort)
  - **Manual OpenShift**: Set to Route URL if you create a Route
- `COVERAGE_OUTPUT_DIR` - Directory for coverage output (default: `./coverage-output`)
  - **Konflux pipeline**: Set to `/tmp/coverage-output` (writable location)
  - **Local**: Uses default `./coverage-output` in project directory
- `PUSH_COVERAGE_ARTIFACT` - Enable pushing coverage artifacts to OCI registry (default: disabled)
  - **Konflux pipeline**: Set to `true` to push to `quay.io/psturc/coverage-artifacts`
  - **Local**: Not set by default (coverage saved locally only)
  - Requires Docker authentication configured in `~/.docker/config.json`

These are automatically set by the pipeline but can be overridden for local testing.

### Deployment Manifests

- **Base manifest** (`k8s-deployment.yaml`): Uses NodePort Service for local Kind testing
- **Konflux pipeline**: Automatically converts NodePort â†’ ClusterIP and adds OpenShift Route
- **Manual OpenShift**: Use base manifest or create Route manually with `oc create route edge`

